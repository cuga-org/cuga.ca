<!DOCTYPE html>
<html lang="fr">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-T2BEK56YJ1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-T2BEK56YJ1');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CUGA Clubs - Canadian Underwater Games Association</title>
    <link href="https://fonts.googleapis.com/css2?family=Kumbh+Sans:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.tailwindcss.com"></script> <!-- Retaining Tailwind for existing content -->
    <link rel="stylesheet" href="assets/fontawesome/css/font-awesome.min.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            AOS.init({
                duration: 1000, // Durée de l'animation en millisecondes
                once: true, // Animation uniquement lors du premier défilement
            });
        });
    </script>
    <style>
        .bubbles {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .bubble {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            opacity: 0.7;
            animation: rise 10s infinite ease-in;
        }

        @keyframes rise {
            0% {
                bottom: -100px;
                transform: translateX(0);
            }
            50% {
                transform: translateX(100px);
            }
            100% {
                bottom: 1080px;
                transform: translateX(-100px);
                opacity: 0;
            }
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-blue-700 text-white">
    <div class="bubbles">
    </div>

    <div class="text-center py-4 bg-gray-200">
        <button class="lang-button px-4 py-2 mr-2 rounded bg-blue-500 text-white" data-lang="fr">
            <i class="fa fa-fleur-de-lis"></i> Français
        </button>
        <button class="lang-button px-4 py-2 rounded bg-gray-400 text-gray-800" data-lang="en">
            <i class="fa fa-canadian-maple-leaf"></i> English
        </button>
    </div>

    <div id="experimental-banner-container" class="text-center py-3 bg-yellow-300 text-black text-sm">
        <div id="lang-en-banner">
            This is an experimental website for CUGA. The official CUGA website can be found at <a href="https://cuga.org/" target="_blank" rel="noopener noreferrer" class="underline font-semibold hover:text-blue-700">https://cuga.org/</a>.
        </div>
        <div id="lang-fr-banner" class="hidden">
            Ceci est un site web expérimental pour CUGA. Le site officiel de CUGA se trouve à <a href="https://cuga.org/" target="_blank" rel="noopener noreferrer" class="underline font-semibold hover:text-blue-700">https://cuga.org/</a>.
        </div>
    </div>

    <!-- Applying .site-header, .site-logo-link, .site-logo -->
    <header class="site-header">
        <a href="index.html" class="site-logo-link"> <!-- Assuming index.html is the home page -->
            <img id="cugaLogo" src="assets/logos/CUGA/Horizontal/FR/FullColor/CUGA-logo-h-fr-fullColor-rgb.svg" alt="CUGA Logo" class="site-logo">
        </a>
        <!-- Hamburger menu button will be needed here for consistency if other pages have it -->
        <!-- For now, leaving it out as this page has its own navigation (language buttons) -->
        <!-- Note: The text-white, text-center, shadow-lg, py-8 Tailwind classes were removed -->
        <!-- Subtitle and Tagline are outside the standard .site-header structure, will need custom styling or new classes -->
    </header>
    <div class="text-center py-4" style="background-color: var(--primary-color); color: var(--white);"> <!-- Replicating old header visual for subtitle/tagline -->
        <p id="cugaSubtitle" class="text-md md:text-lg italic">Association Canadienne des Jeux Subaquatiques</p>
        <p id="cugaTagline" class="mt-1 text-md md:text-lg italic">Plongez dans l'action avec le Hockey et le Rugby Subaquatique !</p>
    </div>


    <div id="filter-controls" class="w-full px-4 py-8 bg-gray-100 text-gray-800 rounded-lg shadow-md">
        <!-- Filter controls will be added here -->
    </div>

    <div id="clubs-container" class="w-full px-4 py-8 overflow-x-auto text-gray-800">
        <!-- Club listings will be displayed here -->
    </div>

    <footer id="footer-fr" class="site-footer-bar">
        <!-- Note: Removed Tailwind classes like bg-gray-900, text-gray-400, py-8, text-center -->
        <!-- The div.container.mx-auto.px-4 structure is slightly different from site-footer-bar's direct content model -->
        <!-- For now, will keep internal structure and let site-footer-bar handle overall background/padding -->
        <div class="footer-content-wrapper" style="width: 100%; display: flex; flex-direction: column; align-items: center;"> <!-- Helper for centering multi-line content -->
            <div class="external-links py-2"> <!-- py-2 for some spacing, adjust as needed -->
                 <p class="mt-2 flex flex-wrap justify-center gap-2 items-center">
                    <span>
                        <i class="fa fa-canadian-maple-leaf text-red-500 mr-1"></i>
                        <a href="https://cuga.org/fr/" target="_blank" rel="noopener noreferrer">Association Canadienne des Jeux Sous-Marins</a>
                    </span>
                    <span class="mx-2">|</span>
                    <span>
                        <i class="fa fa-globe text-green-200 mr-1"></i>
                        <a href="https://www.cmas.org/hockey/latest.html" target="_blank" rel="noopener noreferrer">CMAS Hockey subaquatique</a>
                    </span>
                    <span class="mx-2">|</span>
                    <span>
                        <i class="fa fa-globe text-green-200 mr-1"></i>
                        <a href="https://www.cmas.org/rugby/latest.html" target="_blank" rel="noopener noreferrer">CMAS Rugby subaquatique</a>
                    </span>
                </p>
            </div>
            <div class="footer-copyright">
                &copy; <span id="currentYearFr">2025</span> CUGA. Tous droits réservés. <!-- Year will be updated by JS -->
            </div>
            <div class="footer-links">
                <!-- Tailwind classes like text-blue-400 hover:underline removed, will rely on site-footer-bar a styles -->
                <a href="docs/CUGA%20Code%20of%20Conduct%20(June%202022).pdf" target="_blank">Code de Conduite CUGA</a>
                <a href="docs/CUGA%20Constitution%20%26%20By-laws%20(2024).pdf" target="_blank">Règlements de la CUGA</a>
                <a href="privacy-policy.html">Politique de Confidentialité</a>
                <a href="terms-of-use.html">Conditions d'Utilisation</a>
            </div>
        </div>
    </footer>
    <footer id="footer-en" class="site-footer-bar hidden">
        <div class="footer-content-wrapper" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
            <div class="external-links py-2">
                <p class="mt-2 flex flex-wrap justify-center gap-2 items-center">
                    <span>
                        <i class="fa fa-canadian-maple-leaf text-red-500 mr-1"></i>
                        <a href="https://cuga.org/en/" target="_blank" rel="noopener noreferrer">CUGA (Canadian Underwater Games Association)</a>
                    </span>
                    <span class="mx-2">|</span>
                    <span>
                        <i class="fa fa-globe text-green-200 mr-1"></i>
                        <a href="https://www.cmas.org/hockey/latest.html" target="_blank" rel="noopener noreferrer">CMAS Underwater Hockey</a>
                    </span>
                    <span class="mx-2">|</span>
                    <span>
                        <i class="fa fa-globe text-green-200 mr-1"></i>
                        <a href="https://www.cmas.org/rugby/latest.html" target="_blank" rel="noopener noreferrer">CMAS Underwater Rugby</a>
                    </span>
                </p>
            </div>
            <div class="footer-copyright">
                &copy; <span id="currentYearEn">2025</span> CUGA. All rights reserved. <!-- Year will be updated by JS -->
            </div>
            <div class="footer-links">
                <a href="docs/CUGA%20Code%20of%20Conduct%20(June%202022).pdf" target="_blank">CUGA Code of Conduct</a>
                <a href="docs/CUGA%20Constitution%20%26%20By-laws%20(2024).pdf" target="_blank">CUGA Bylaws</a>
                <a href="privacy-policy.html">Privacy Policy</a>
                <a href="terms-of-use.html">Terms of Use</a>
            </p>
        </div>
    </footer>


    <script>
        // --- App Logging Configuration (with defaults, will be updated from config.json) ---
        let AppLoggerConfig = {
            enabled: false,
            logLevel: 'warn',
        };

        function appLog(level, ...args) {
            if (!AppLoggerConfig.enabled) {
                return;
            }
            const levels = ['debug', 'info', 'warn', 'error'];
            const configLevelIndex = levels.indexOf(AppLoggerConfig.logLevel.toLowerCase());
            const messageLevelIndex = levels.indexOf(level.toLowerCase());
            if (messageLevelIndex === -1 || messageLevelIndex < configLevelIndex) {
                return;
            }
            const timestamp = new Date().toISOString();
            let consoleMethod = console.log;
            if (console[level.toLowerCase()] && typeof console[level.toLowerCase()] === 'function') {
                consoleMethod = console[level.toLowerCase()];
            }
            consoleMethod(`[${timestamp}] [${level.toUpperCase()}]`, ...args);
        }

        async function loadAppConfig() {
            try {
                const response = await fetch('config.json');
                if (!response.ok) {
                    console.error('Failed to fetch config.json. Status:', response.status, 'Using default AppLoggerConfig.');
                    return;
                }
                const fetchedConfig = await response.json();
                if (fetchedConfig.logging) {
                    AppLoggerConfig.enabled = typeof fetchedConfig.logging.enabled === 'boolean' ? fetchedConfig.logging.enabled : AppLoggerConfig.enabled;
                    AppLoggerConfig.logLevel = fetchedConfig.logging.logLevel || AppLoggerConfig.logLevel;
                }
                console.log("AppLoggerConfig after attempting to load config.json:", JSON.parse(JSON.stringify(AppLoggerConfig)));
            } catch (error) {
                console.error('Error loading or parsing config.json:', error, 'Using default AppLoggerConfig.');
            }
        }

        let allClubs = [];
        let currentLanguage = 'fr';
        let selectedSport = 'All';
        let selectedProvince = 'All';

        const provinceTimezones = {
            "Alberta": "America/Edmonton", "British Columbia": "America/Vancouver", "Manitoba": "America/Winnipeg",
            "New Brunswick": "America/Moncton", "Newfoundland and Labrador": "America/St_Johns", "Nova Scotia": "America/Halifax",
            "Ontario": "America/Toronto", "Prince Edward Island": "America/Halifax", "Quebec": "America/Montreal",
            "Saskatchewan": "America/Regina", "Northwest Territories": "America/Yellowknife", "Nunavut": "America/Iqaluit",
            "Yukon": "America/Whitehorse"
        };
        const defaultTimezone = "America/Toronto";

        const headersMap = {
            'en': {
                sportType: "Sport Type", clubName: "Club Name", city: "City", practiceTimes: "Practice Times",
                practiceLocationColumn: "Practice Location", linksColumn: "Links",
                filterSportTypeLabel: "Filter by Sport Type:", filterProvinceLabel: "Filter by Province:", allOption: "All",
                AriaDownloadICS: "Download schedule as ICS", AriaEmailLink: "Email", AriaWebsiteLink: "Visit website",
                AriaFacebookLink: "Visit Facebook page", AriaInstagramLink: "Visit Instagram page", NotesPrefix: "Notes:",
                noClubsMatch: "No clubs match the current filters.", noClubData: "No club data available.",
                noRRule: "No valid recurrence rule found for this club (RRULE is empty or NA).",
                noEventsGenerated: "Could not generate any valid events for this club's schedule (no valid VEVENTs created).",
                noIndividualRRules: "No valid individual recurrence rules could be parsed for this club."
            },
            'fr': {
                sportType: "Type de sport", clubName: "Nom du club", city: "Ville", practiceTimes: "Heures de pratique",
                linksColumn: "Liens", practiceLocationColumn: "Lieu de pratique",
                filterSportTypeLabel: "Filtrer par type de sport :", filterProvinceLabel: "Filtrer par province :", allOption: "Tous",
                AriaDownloadICS: "Télécharger l'horaire en ICS", AriaEmailLink: "Courriel", AriaWebsiteLink: "Visiter le site web",
                AriaFacebookLink: "Visiter la page Facebook", AriaInstagramLink: "Visiter la page Instagram", NotesPrefix: "Remarques:",
                noClubsMatch: "Aucun club ne correspond aux filtres actuels.", noClubData: "Aucune donnée de club disponible.",
                noRRule: "Aucune règle de récurrence valide trouvée pour ce club (RRULE est vide ou NA).",
                noEventsGenerated: "Impossible de générer des événements valides pour l'horaire de ce club (aucun VEVENT valide créé).",
                noIndividualRRules: "Aucune règle de récurrence individuelle valide n'a pu être analysée pour ce club."
            }
        };

        const siteContent = {
            header: {
                fr: {
                    logo: "assets/logos/CUGA/Horizontal/FR/FullColor/CUGA-logo-h-fr-fullColor-rgb.svg",
                    subtitle: "Association Canadienne des Jeux Subaquatiques",
                    tagline: "Plongez dans l'action avec le Hockey et le Rugby Subaquatique !"
                },
                en: {
                    logo: "assets/logos/CUGA/Horizontal/EN/FullColor/CUGA-logo-h-en-fullColor-rgb.svg",
                    subtitle: "Canadian Underwater Games Association",
                    tagline: "Dive into the action with Underwater Hockey and Underwater Rugby!"
                }
            }
        };

        function populateFilterDropdowns(language) {
            const filterControlsContainer = document.getElementById('filter-controls');
            if (!filterControlsContainer) { console.error('Filter controls container not found!'); return; }
            filterControlsContainer.innerHTML = '';

            const langStrings = headersMap[language];

            const sportTypeLabel = document.createElement('label');
            sportTypeLabel.setAttribute('for', 'sport-type-filter');
            sportTypeLabel.textContent = langStrings.filterSportTypeLabel + ' ';
            filterControlsContainer.appendChild(sportTypeLabel);

            const sportTypeFilter = document.createElement('select');
            sportTypeFilter.id = 'sport-type-filter';
            sportTypeFilter.classList.add("text-black", "p-2", "border", "rounded", "mr-4");

            const defaultSportOption = document.createElement('option');
            defaultSportOption.value = 'All';
            defaultSportOption.textContent = langStrings.allOption;
            sportTypeFilter.appendChild(defaultSportOption);

            let uniqueSportTypes = [...new Set(allClubs.map(club => club.SportType).filter(st => st))].sort();
            uniqueSportTypes.forEach(sportType => {
                const option = document.createElement('option');
                option.value = sportType;
                const representativeClub = allClubs.find(club => club.SportType === sportType);
                option.textContent = (language === 'fr' && representativeClub && representativeClub.SportTypeFR) ? representativeClub.SportTypeFR : sportType;
                sportTypeFilter.appendChild(option);
            });
            sportTypeFilter.value = selectedSport;
            sportTypeFilter.addEventListener('change', (e) => {
                selectedSport = e.target.value;
                displayClubs(currentLanguage);
            });
            filterControlsContainer.appendChild(sportTypeFilter);

            const provinceLabel = document.createElement('label');
            provinceLabel.setAttribute('for', 'province-filter');
            provinceLabel.textContent = langStrings.filterProvinceLabel + ' ';
            filterControlsContainer.appendChild(provinceLabel);

            const provinceFilter = document.createElement('select');
            provinceFilter.id = 'province-filter';
            provinceFilter.classList.add("text-black", "p-2", "border", "rounded");

            const defaultProvinceOption = document.createElement('option');
            defaultProvinceOption.value = 'All';
            defaultProvinceOption.textContent = langStrings.allOption;
            provinceFilter.appendChild(defaultProvinceOption);

            let uniqueProvinces = [...new Set(allClubs.map(club => club.Province).filter(p => p))].sort();
            uniqueProvinces.forEach(province => {
                const option = document.createElement('option');
                option.value = province;
                const representativeClub = allClubs.find(club => club.Province === province);
                option.textContent = (language === 'fr' && representativeClub && representativeClub.ProvinceFR) ? representativeClub.ProvinceFR : province;
                provinceFilter.appendChild(option);
            });
            provinceFilter.value = selectedProvince;
            provinceFilter.addEventListener('change', (e) => {
                selectedProvince = e.target.value;
                displayClubs(currentLanguage);
            });
            filterControlsContainer.appendChild(provinceFilter);
        }

        async function fetchClubData() {
            const url = 'cuga_club_data.json'; // Changed URL
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} while fetching ${url}`);
                }
                allClubs = await response.json(); // Directly parse JSON array
                appLog('debug', "Processed club data from local JSON:", allClubs);

                if (!Array.isArray(allClubs)) {
                    console.error("Error: Fetched club data is not an array.", allClubs);
                    allClubs = []; // Reset to empty array on error
                    // Display error to user in the clubs container
                    const clubsContainer = document.getElementById('clubs-container');
                    if (clubsContainer) clubsContainer.innerHTML = `<p>${headersMap[currentLanguage]?.noClubData || 'No club data available (error loading data).'}</p>`;
                    const filterControlsContainer = document.getElementById('filter-controls');
                    if (filterControlsContainer) filterControlsContainer.innerHTML = ''; // Clear filters
                    return; // Stop further processing
                }

            } catch (error) {
                console.error("Error fetching or parsing local club data:", error);
                allClubs = []; // Ensure allClubs is empty on error
                const clubsContainer = document.getElementById('clubs-container');
                if (clubsContainer) clubsContainer.innerHTML = `<p>${headersMap[currentLanguage]?.noClubData || 'No club data available (error fetching data).'}</p>`;
                const filterControlsContainer = document.getElementById('filter-controls');
                if (filterControlsContainer) filterControlsContainer.innerHTML = ''; // Clear filters
            }
        }

        function displayClubs(language) {
            if (allClubs.length > 0) {
                populateFilterDropdowns(language);
            } else if (document.getElementById('filter-controls')) {
                 document.getElementById('filter-controls').innerHTML = '';
            }

            const clubsContainer = document.getElementById('clubs-container');
            if (!clubsContainer) { console.error('Clubs container not found!'); return; }
            clubsContainer.innerHTML = '';

            const langHeaders = headersMap[language];
            const table = document.createElement('table');
            table.classList.add("min-w-full", "divide-y", "divide-gray-200", "shadow", "overflow-hidden", "border-b", "border-gray-200", "sm:rounded-lg");
            table.innerHTML = `
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${langHeaders.clubName}</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${langHeaders.sportType}</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${langHeaders.city}</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${langHeaders.practiceTimes}</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${langHeaders.practiceLocationColumn}</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${langHeaders.linksColumn}</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                </tbody>
            `;
            const tbody = table.querySelector('tbody');
            let filteredClubs = allClubs;
            if (selectedSport !== 'All') {
                filteredClubs = filteredClubs.filter(club => club.SportType === selectedSport);
            }
            if (selectedProvince !== 'All') {
                filteredClubs = filteredClubs.filter(club => club.Province === selectedProvince);
            }

            if (filteredClubs.length === 0) {
                const colspanCount = table.querySelector('thead tr').children.length;
                tbody.innerHTML = `<tr><td colspan="${colspanCount}" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">${langHeaders.noClubsMatch}</td></tr>`;
                 if (allClubs.length === 0 && !document.getElementById('filter-controls').innerHTML.includes(langHeaders.noClubData)) { // check this condition
                    tbody.innerHTML = `<tr><td colspan="${colspanCount}" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">${langHeaders.noClubData}</td></tr>`;
                }
            } else {
                filteredClubs.forEach(club => {
                    const tr = document.createElement('tr');
                    tr.classList.add("hover:bg-gray-100");

                    const clubName = language === 'fr' && club.ClubNameFR ? club.ClubNameFR : club.ClubName;
                    const sportType = language === 'fr' && club.SportTypeFR ? club.SportTypeFR : club.SportType;
                    const city = language === 'fr' && club.CityFR ? club.CityFR : club.City;

                    tr.insertCell().textContent = clubName;
                    tr.insertCell().textContent = sportType;
                    tr.insertCell().textContent = city;

                    const practiceTimesCell = tr.insertCell();
                    let practiceTimeText = (language === 'fr' && club.PracticeTimesFR && club.PracticeTimesFR.toLowerCase() !== 'na' && club.PracticeTimesFR.trim() !== "") ? club.PracticeTimesFR : club.PracticeTimes;
                    practiceTimesCell.textContent = (!practiceTimeText || practiceTimeText.trim() === "" || practiceTimeText.toLowerCase() === 'na') ? "NA" : practiceTimeText;

                    const practiceLocationCell = tr.insertCell();
                    let locationContent = (language === 'fr' && club.PracticeLocationFR && club.PracticeLocationFR.toLowerCase() !== 'na' && club.PracticeLocationFR.trim() !== "") ? club.PracticeLocationFR : club.PracticeLocation;
                    practiceLocationCell.innerHTML = (!locationContent || locationContent.trim() === "" || locationContent.toLowerCase() === 'na') ? "NA" : locationContent;

                    const linksCell = tr.insertCell();
                    linksCell.classList.add("px-6", "py-4", "whitespace-nowrap", "text-sm", "text-gray-500");
                    const linksLangHeaders = headersMap[language];

                    const createIconLink = (href, ariaLabelKey, iconClass, isMailto = false) => {
                        const anchor = document.createElement('a');
                        anchor.className = 'link-icon-anchor inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500';
                        if (!isMailto) { anchor.target = '_blank'; anchor.rel = 'noopener noreferrer'; }
                        anchor.href = href;
                        const ariaLabelText = linksLangHeaders[ariaLabelKey] || "";
                        const fullAriaLabel = href ? `${ariaLabelText} ${href}` : ariaLabelText;
                        anchor.setAttribute('aria-label', fullAriaLabel);
                        const span = document.createElement('span');
                        span.className = 'link-icon';
                        const iconTag = document.createElement('i');
                        iconTag.className = `fa ${iconClass} fa-lg`;
                        iconTag.setAttribute('aria-hidden', 'true');
                        span.appendChild(iconTag);
                        anchor.appendChild(span);
                        return anchor;
                    };

                    if (club.ContactEmail && club.ContactEmail !== "NA") { linksCell.appendChild(createIconLink(`mailto:${club.ContactEmail}`, 'AriaEmailLink', 'fa-envelope', true));}
                    if (club.WebsiteURL && club.WebsiteURL !== "NA") { linksCell.appendChild(createIconLink(club.WebsiteURL, 'AriaWebsiteLink', 'fa-globe'));}
                    if (club.FacebookURL && club.FacebookURL !== "NA") { linksCell.appendChild(createIconLink(club.FacebookURL, 'AriaFacebookLink', 'fa-facebook-square'));}
                    if (club.InstagramURL && club.InstagramURL !== "NA") { linksCell.appendChild(createIconLink(club.InstagramURL, 'AriaInstagramLink', 'fa-instagram'));}

                    const scheduleLink = document.createElement('a');
                    scheduleLink.className = 'ics-button inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500';
                    scheduleLink.innerHTML = '<i class="fa fa-calendar fa-lg" aria-hidden="true"></i>';
                    const ariaLabelICS = linksLangHeaders.AriaDownloadICS || "Download schedule as ICS";
                    scheduleLink.setAttribute('aria-label', ariaLabelICS);

                    if (club.ics_file_path && club.ics_file_path.trim() !== "") {
                        scheduleLink.href = club.ics_file_path;
                        scheduleLink.setAttribute('download', ''); // Optional: Suggests filename from href path
                    } else {
                        scheduleLink.classList.add("opacity-50", "cursor-not-allowed");
                        scheduleLink.setAttribute('aria-disabled', 'true'); // For accessibility
                        scheduleLink.removeAttribute('href'); // No link if no file
                        // Optionally, add a title to explain why it's disabled
                        scheduleLink.setAttribute('title', headersMap[language]?.noEventsGenerated || 'No schedule file available.');
                    }
                    linksCell.appendChild(scheduleLink);

                    if (linksCell.children.length === 0) { linksCell.textContent = "NA"; }
                    Array.from(tr.children).forEach((td, index) => {
                        td.classList.add("px-6", "py-4", "text-sm", "text-gray-900");
                        // Index 3 is Practice Times, Index 4 is Practice Location
                        if (index === 3 || index === 4) {
                            td.classList.add("whitespace-normal");
                        } else {
                            td.classList.add("whitespace-nowrap");
                        }
                    });
                    tbody.appendChild(tr);
                });
            }
            clubsContainer.appendChild(table);
        }

        // Removed generateICS(club)
        // Removed calculateNextDtFromRrule(rruleString, clubPracticeTimeString)
        // Removed formatUTCDate(date)

        document.addEventListener('DOMContentLoaded', async () => {
            await loadAppConfig();
            appLog('info', 'Application configuration loaded successfully.');
            await fetchClubData();

            const langButtons = document.querySelectorAll('.lang-button');
            const cugaLogo = document.getElementById('cugaLogo');
            const cugaSubtitle = document.getElementById('cugaSubtitle');
            const cugaTagline = document.getElementById('cugaTagline');
            const footerFr = document.getElementById('footer-fr');
            const footerEn = document.getElementById('footer-en');
            const bannerFr = document.getElementById('lang-fr-banner');
            const bannerEn = document.getElementById('lang-en-banner');

            // Update copyright year
            const currentYear = new Date().getFullYear();
            const currentYearFrSpan = document.getElementById('currentYearFr');
            if (currentYearFrSpan) currentYearFrSpan.textContent = currentYear;
            const currentYearEnSpan = document.getElementById('currentYearEn');
            if (currentYearEnSpan) currentYearEnSpan.textContent = currentYear;


            const setLanguage = (lang) => {
                currentLanguage = lang;
                selectedSport = 'All';
                selectedProvince = 'All';

                if (siteContent.header[lang]) {
                    cugaLogo.src = siteContent.header[lang].logo;
                    cugaSubtitle.textContent = siteContent.header[lang].subtitle;
                    cugaTagline.textContent = siteContent.header[lang].tagline;
                }

                if (lang === 'fr') {
                    footerFr.classList.remove('hidden');
                    footerEn.classList.add('hidden');
                    bannerFr.classList.remove('hidden');
                    bannerEn.classList.add('hidden');
                } else {
                    footerEn.classList.remove('hidden');
                    footerFr.classList.add('hidden');
                    bannerEn.classList.remove('hidden');
                    bannerFr.classList.add('hidden');
                }

                langButtons.forEach(button => {
                    button.classList.toggle('bg-blue-600', button.dataset.lang === lang);
                    button.classList.toggle('text-white', button.dataset.lang === lang);
                    button.classList.toggle('bg-gray-400', button.dataset.lang !== lang);
                    button.classList.toggle('text-gray-800', button.dataset.lang !== lang);
                });

                document.documentElement.lang = lang;
                displayClubs(lang);
                localStorage.setItem('language', lang); // Store language choice
            };

            const storedLang = localStorage.getItem('language');
            if (storedLang) {
                setLanguage(storedLang);
            } else {
                const browserLang = (navigator.language || navigator.userLanguage || 'fr').slice(0, 2);
                const initialLang = (browserLang === 'en' || browserLang === 'fr') ? browserLang : 'fr';
                setLanguage(initialLang);
            }

            langButtons.forEach(button => {
                button.addEventListener('click', () => setLanguage(button.dataset.lang));
            });

            window.addEventListener('pageshow', function(event) {
                if (event.persisted) { // True if page is from bfcache
                    console.log('cuga.html: Page shown from bfcache'); // Optional: for debugging
                    const storedLang = localStorage.getItem('language');
                    if (storedLang) {
                        setLanguage(storedLang); // setLanguage is accessible here
                    } else {
                        // Fallback logic if no language is in localStorage
                        const browserLang = (navigator.language || navigator.userLanguage || 'fr').slice(0, 2);
                        const initialLang = (browserLang === 'en' || browserLang === 'fr') ? browserLang : 'fr';
                        setLanguage(initialLang);
                    }
                }
            });
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => { /* Bubble script unchanged */
            const bubblesContainer = document.querySelector('.bubbles');
            function createBubble() {
                const bubble = document.createElement('div');
                bubble.classList.add('bubble');
                const size = Math.random() * 40 + 10;
                bubble.style.width = `${size}px`;
                bubble.style.height = `${size}px`;
                bubble.style.left = `${Math.random() * 100}%`;
                const animationDuration = Math.random() * 10 + 5;
                bubble.style.animationDuration = `${animationDuration}s`;
                bubblesContainer.appendChild(bubble);
                setTimeout(() => { bubble.remove(); }, animationDuration * 1000);
            }
            setInterval(createBubble, 500);
        });
    </script>
</body>
</html>
